#!/bin/bash


## Changing PWD
cd $(dirname $0)

## For sending emails
EMAILS=

## Force to reload and update all running VMs
FORCE_UPDATE=

## Configs and Libs
source mad-gantry.conf
source ticket.conf
for func in $(ls libs/*.sh); do source $func; done

## Making dirs
[ ! -e $SHIP_DIR ] && mkdir -v $SHIP_DIR
[ ! -e $PAYLOADS_DIR ] && mkdir -v $PAYLOADS_DIR


## Set a default YML template
TEMPLATE_DIR=templates/$DEFAULT_TEMPLATE
YML_FILE=$TEMPLATE_DIR/docker-compose.yml
ALL_TEMPLATES=$(ls templates | perl -pe "s/\s/\//g" | perl -pe "s/\/$//g")

## All existing ship containers
ALL_SHIP_TEMPLATES=$(ls $SHIP_DIR | grep -v .html| perl -pe "s/\s/\//g" | perl -pe "s/\/$//g")



usage="$0 [option]
$(basename $0), which uses docker-compose, is designed to build and run the standard HappyFace/HappyFaceMobile Monitoring systems on containers. This powerful command can easily ship many monitoring frameworks to Cloud/Cluster/WLCG environments.

 -I:  Install basic packages in this host node
 -d:  Make development environments in $PAYLOADS_DIR
 -E:  email addresses

 -n:  Use docker-compose no-cache option
 -y:  Set a template YML file [default: $YML_FILE]
 -t:  Select a template [$ALL_TEMPLATES]
 -a:  Actions [build/up/down/logs/reload/inspect]
 -u:  Update development environments, and reload all running containers. Provide a template name [$ALL_TEMPLATES]

 -i:  Select a ship image [default: $SHIP_IMAGE]
 -s:  Select a ship template [$ALL_SHIP_TEMPLATES]
 -c:  Connect a container via ssh

 -A:  Put all (top, countries, sites) containers onto a ship
 -T:  Put a top container onto a ship
 -C:  Put a country container onto a ship  [country_code or all]
 -S:  Put a site container onto a a ship [site_name or all]
 -L:  Put a local site container onto a ship [local_name or all]

 * Examples
 ** Build [$DEFAULT_TEMPLATE] template images and run them
 $0 -a build; $0 -a up

 ** Build xdesktop template images and run them
 $0 -t xdesktop -a build; $0 -t xdesktop -a up

 ** Make deferent levels templates and run their containers
 $0 -T; $0 -s ADC -a up
 $0 -C DE; $0 -s DE -a up
 $0 -S GoeGrid; $0 -s GoeGrid -a up
 $0 -L GoeGrid_Custom; $0 -s GoeGrid_Custom -a up

 ** Make all templates [from level0 to level3]
 $0 -A

 ** Connect a site container via ssh
 $0 -s GoeGrid -c

 Report Bugs to Gen Kawamura <gen.kawamura@cern.ch>"

if [ $# -eq 0 ]; then
    echo "$usage"
    exit 0
fi


#--------------------------
# Functions
#--------------------------
docker_compose_action(){
    local action="$1"
    local yml_file="$2"
    [ -z "$yml_file" ] && yml_file=$YML_FILE

    ## Check requirements
    ! which docker-compose &> /dev/null && echo "docker-compose does not exist. Use -I option." && exit -1

    ## Check YML file
    [ ! -e $yml_file ] && echo "No YML file [$yml_file]" && return 1
    echo "YML = [$yml_file], docker-compose action = [$action]"

    case $action in
	build)
	    docker-compose -f $yml_file build $DOCKER_COMPOSE_NO_CACHE
	    return $?
	    ;;
	up)
	    docker-compose -f $yml_file up -d
	    return $?
	    ;;
	down)
	    docker-compose -f $yml_file down
	    return $?
	    ;;
	logs)
	    docker-compose -f $yml_file logs
	    return $?
	    ;;
	reload)
	    docker-compose -f $yml_file ps | grep  " Up " &> /dev/null
	    [ $? -ne 0 ] && echo "[$yml_file] --> [Stopped]" && return 1
	    ## Looping until it succeeds
	    for i in $(seq 1 5)
	    do
		echo "Reloading a VM [$(grep -B 1 image: $yml_file | perl -pe 'chomp')]"
		docker-compose -f $yml_file down
		docker-compose -f $yml_file up -d
		[ $? -eq 0 ] && return 0
		echo "Retrying [$i/10]..."
		sleep 60
	    done
	    return 1
	    ;;
	inspect)
	    docker-compose -f $yml_file ps | grep  " Up " &> /dev/null
	    if [ $? -eq 0 ]; then
		echo "[$yml_file] --> [Running]" && return 0
	    else
		echo "[$yml_file] --> [Stopped]" && return 1
	    fi
	    ;;
	*)
	    echo "$usage"
	    exit -1
	    ;;
    esac

    return 1
}


output_docker_yml(){
    local site_names=($1)
    local hosts=($2)
    local ports=($3)

    local i
    for i in $(seq 0 $((${#site_names[*]} - 1)))
    do
	local docker_yml_file=$SHIP_DIR/${site_names[$i]}/docker-compose.yml
	local site=${site_names[$i]}
	local host=${hosts[$i]}
	local web_port=$(($WEB_PORT_START + ${ports[$i]}))
	local mobile_port=$(($MOBILE_PORT_START + ${ports[$i]}))
	local ssh_port=$(($SSH_PORT_START + ${ports[$i]}))

	echo "Writing [$docker_yml_file] ($site, $host, $web_port, $mobile_port)..."
	[ ! -e $(dirname $docker_yml_file) ] && mkdir -v $(dirname $docker_yml_file)

	## Output minimum site configuration
	echo "version: \"$DOCKER_YML_VERSION\"
services:

 # Mad-Gantry Ship Platform
 ${site}:
  image: $SHIP_IMAGE
  ports:
    - \"${web_port}:$DEFAULT_WEB_PORT\"
    - \"${mobile_port}:$DEFAULT_MOBILE_PORT\"
    - \"${ssh_port}:$DEFAULT_SSH_PORT\"
  volumes: 
    - \"$PWD/$PAYLOADS_DIR/sites/${site}:$PAYLOAD_SITES/${site}\"
    - \"$PWD/$PAYLOADS_DIR/data/${site}:$PAYLOAD_DATA/${site}\"
    - \"$PWD/$PAYLOADS_DIR/devel:$PAYLOAD_DEVEL\"
    - \"$PWD/$PAYLOADS_DIR/android-tools:$PAYLOAD_ANDROID_TOOLS\"
    - \"$PWD/$PAYLOADS_DIR/ssh:/root/.ssh\"
  # The followings are to avoid D-Bus error in CentOS7
    - \"/sys/fs/cgroup:/sys/fs/cgroup:ro\"
  cap_add:
    - SYS_ADMIN
  security_opt:
    - seccomp:unconfined
" > $docker_yml_file
    done

}


output_meta_meta_config(){
    local site_names=($1)
    local hosts=($2)
    local ports=($3)
    local site_dir=$4
    local meta_meta_json=$site_dir/meta-meta.json

    ## Outputting a meta_meta_config content
    [ ! -e $site_dir ] && mkdir -pv $site_dir
    if [ -z "$1" ] && [ -e $meta_meta_json ]; then
	echo "Skipping [$meta_meta_json]" && return 0
    fi

    ## Begining
    echo "Writing [$meta_meta_json] ..."
    echo "[{" > $meta_meta_json

    local i
    for i in $(seq 0 $((${#site_names[*]} - 1)))
    do

	## Main content
	local site=${site_names[$i]}
	local web_port=$(($WEB_PORT_START + ${ports[$i]}))
	local mobile_port=$(($MOBILE_PORT_START + ${ports[$i]}))

	echo "   \"name\": \"${site}\",
   \"host\": \"${hosts[$i]}\",
   \"web_port\": \"${web_port}\",
   \"mobile_port\": \"${mobile_port}\",
   \"dir\": \"sites/${site}\" " >> $meta_meta_json

	## Next
	[ $i -ne $((${#site_names[*]} - 1)) ] && echo "},{" >> $meta_meta_json
    done

    ## Ending
    echo "}]" >> $meta_meta_json

    return 0
}


copy_site_configs(){
    local level=$1
    local site_dir=$2
    local site=$(basename $site_dir)

    [ ! -e $site_dir ] && mkdir -pv $site_dir

    ## Copying default site configuration
    if [ -e configs/$level ]; then
	echo "Copying [$site] site configuration from [configs/$level]..."
	cp -r configs/$level/* $site_dir
    fi

    ## Overwriting by custom configurations
    if [ -e configs/customs/$site ]; then
	echo "Copying [$site] custom onfiguration from [configs/customs/$site]..."
	cp -rv configs/customs/$site/* $site_dir
    fi
}


output_href(){
    local site="$1"
    local host="$2"
    local port="$3"

    local web_port=$(($WEB_PORT_START + ${port}))
    local mobile_port=$(($MOBILE_PORT_START + ${port}))    

    echo "<a href=\"http://$host:$web_port\">HappyFace Web: $site</a></br>"
    echo "<a href=\"http://$host:$mobile_port\">HappyFace Mobile: $site</a></br>"
}


output_ship_html(){
    echo "Outputting [$SHIP_DIR/ship.html] ..."

    ## Header
    echo "<html><header></header><body>" > $SHIP_DIR/ship.html

    ## Level 0
    output_href "$LEVEL0_SITE" "$LEVEL0_HOST" "$LEVEL0_PORT" >> $SHIP_DIR/ship.html

    ## Level 1
    for i in $(seq 0 $((${#LEVEL1_SITES[*]} - 1)))
    do
	output_href "${LEVEL1_SITES[$i]}" "${LEVEL1_HOSTS[$i]}" "${LEVEL1_PORTS[$i]}" >> $SHIP_DIR/ship.html
    done

    ## Level 2
    for i in $(seq 0 $((${#ALL_LEVEL2_SITES[*]} - 1)))
    do
	output_href "${ALL_LEVEL2_SITES[$i]}" "${ALL_LEVEL2_HOSTS[$i]}" "${ALL_LEVEL2_PORTS[$i]}" >> $SHIP_DIR/ship.html
    done

    ## Footer
    echo "</body></html>" >> $SHIP_DIR/ship.html

}


## Firing all containers in a ship, when "all" is given.
gunship(){
    SITE_NAME="$1"
    local action="$2"

    [ -z "$SITE_NAME" ] && return 1

    if [ "$SITE_NAME" != "all" ]; then
	TEMPLATE_DIR=$SHIP_DIR/$SITE_NAME
	YML_FILE=$TEMPLATE_DIR/docker-compose.yml
	return 1
    elif [ "$SITE_NAME" == "all" ] && [ -z "$action" ]; then
	echo "YML_FILE = [$YML_FILE]"
	return 1
    fi

    ## Fire!!
    ## Level 0
    YML_FILE=$SHIP_DIR/$LEVEL0_SITE/docker-compose.yml
    docker_compose_action $action

    ## Level 1
    for i in $(seq 0 $((${#LEVEL1_SITES[*]} - 1)))
    do
	YML_FILE=$SHIP_DIR/${LEVEL1_SITES[$i]}/docker-compose.yml
	docker_compose_action $action
    done

    ## Level 2
    for i in $(seq 0 $((${#ALL_LEVEL2_SITES[*]} - 1)))
    do
	YML_FILE=$SHIP_DIR/${ALL_LEVEL2_SITES[$i]}/docker-compose.yml
	docker_compose_action $action
    done

    return 0
}


update_by_cron_reload(){
    local base_image=$1

    ## For env of a CRON job
    source /etc/profile
    export TERM=xterm
    
    ## If payloads/devel is updated, then start rebuilding
    if prepare_madmask_devel_env || [ "$FORCE_UPDATE" == "true" ]; then

	## Set parameters
	local message_file=/tmp/mad-gantry.autobuild.log 
	local template_yml=templates/$base_image/docker-compose.yml 
	[ ! -e $template_yml ] && echo "YML: [$template_yml] does not exist" && exit -1
	
	## Sending a notification
	local message="$(date): Base image is [$base_image]"
	echo -e "$message\n\n" > $message_file
	cat ship/ship.html >> $message_file
	SENDEMAIL "Starting Automatic Build: [$(get_devel_branch_name)] on [$(hostname -s)]" "$message" "$message_file" "$EMAILS"
	sleep 30
	
	## Build and Reload
	local message="$(date): Building [$YML_FILE]"
	echo -e "\n\n$message" >> $message_file
	docker_compose_action build $template_yml 2>&1 | tee -a $message_file 
	gunship "all" "reload" 2>&1 | tee -a $message_file
	sleep 60

	## Inspect VMs and sending emails
	echo -e "\n\n$(date): Inspecting Running VMs" >> $message_file
	gunship "all" "inspect" 2>&1 | tee -a $message_file
	SENDEMAIL "Reloading the Running VMs: [$(get_devel_branch_name)] on [$(hostname -s)]" "$message" "$message_file" "$EMAILS"
    fi
}


#--------------------------
# Getopt
#--------------------------
while getopts "IdE:nt:a:fu:i:y:ATC:S:s:chv" op
  do
  case $op in
      I) install_basic_packages
	  ;;
      d) prepare_madmask_devel_env
	  ;;
      E) EMAILS="$OPTARG"
	  ;;
      n) DOCKER_COMPOSE_NO_CACHE="--no-cache"
	  ;;
      t) TEMPLATE_DIR=templates/$OPTARG
	  [ ! -e $TEMPLATE_DIR ] && echo "No template for [$TEMPLATE_DIR]" && exit -1
	  YML_FILE=$TEMPLATE_DIR/docker-compose.yml
	  ;;
      y) YML_FILE=$OPTARG
	  ;;
      a) generate_sshkey
	  gunship "$SITE_NAME" "$OPTARG" && exit 0
	  docker_compose_action $OPTARG
	  ;;
      f) FORCE_UPDATE=true
	  ;;
      u) update_by_cron_reload $OPTARG
	  ;;
      i) SHIP_IMAGE="$OPTARG"
	  ;;
      A) put_level0_container_onto_ship
	  put_level1_containers_onto_ship all
	  put_level2_containers_onto_ship all
	  output_ship_html
	  ;;
      T) put_level0_container_onto_ship
	  ;;
      C) put_level1_containers_onto_ship $OPTARG
	  ;;
      S) put_level2_containers_onto_ship $OPTARG
	  ;;
      s) gunship "$OPTARG"
	  ;;
      c) connect_via_ssh $SITE_NAME
	  ;;
      h) echo "$usage"
	  exit 0
	  ;;
      v) echo "$version"
	  exit 0
	  ;;
      ?) echo "$usage"
	  exit 0
	  ;;
  esac
done

