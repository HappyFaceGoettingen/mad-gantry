#!/bin/bash

## Check requirements
! which docker-compose &> /dev/null && echo "docker-compose does not exist" && exit -1

## making dirs
cd $(dirname $0)
source mad-gantry.conf
source ticket.conf

[ ! -e $SHIP_DIR ] && mkdir -v $SHIP_DIR
[ ! -e $PAYLOADS_DIR ] && mkdir -v $PAYLOADS_DIR


## Set a default YML template
TEMPLATE_DIR=templates/$DEFAULT_TEMPLATE
YML_FILE=$TEMPLATE_DIR/docker-compose.yml
ALL_TEMPLATES=$(ls templates | perl -pe "s/\s/\//g" | perl -pe "s/\/$//g")

## All existing ship containers
ALL_SHIP_TEMPLATES=$(ls $SHIP_DIR | perl -pe "s/\s/\//g" | perl -pe "s/\/$//g")

usage="$0 [option]

$(basename $0), which uses docker-compose, is designed to build and run the standard HappyFace/HappyFaceMobile Monitoring systems on containers. This powerful command can easily ship many monitoring frameworks to Cloud/Cluster/WLCG environments.

 -d:  Make development environments in $PAYLOADS_DIR

 -n:  Use docker-compose no-cache option
 -y:  Set a template YML file [default: $YML_FILE]
 -t:  Select a template [$ALL_TEMPLATES]
 -a:  Actions [build/up/down/logs]


 -s:  Select a ship template [$ALL_SHIP_TEMPLATES]

 -A:  Put all (top, countries, sites) containers onto a ship
 -T:  Put a top container onto a ship
 -C:  Put a country container onto a ship  [country_code or all]
 -S:  Put a site container onto a a ship [site_name or all]


 * Examples

 ** Build hf.core images and run them
 $0 -a build; $0 -a up

 ** Build xdesktop images and run them
 $0 -t xdesktop -a build; $0 -t xdesktop -a up

 ** Make a Top level template and run its container
 $0 -T; $0 -s adcos -a up

 ** Make a Country level template and run its container
 $0 -C de; $0 -s de -a up

 ** Make a Site level template and run its container
 $0 -S goegrid; $0 -s goegrid -a up


 Report Bugs to Gen Kawamura <gen.kawamura@cern.ch>"

if [ $# -eq 0 ]; then
    echo "$usage"
    exit 0
fi


#--------------------------
# Functions
#--------------------------
docker_compose_action(){
    case $1 in
	build)
	    docker-compose -f $YML_FILE build $DOCKER_COMPOSE_NO_CACHE
	    ;;
	up)
	    docker-compose -f $YML_FILE up -d
	    ;;
	down)
	    docker-compose -f $YML_FILE down
	    ;;
	logs)
	    docker-compose -f $YML_FILE logs
	    ;;
	*)
	    echo "$usage"
	    exit -1
	    ;;
    esac
}


output_docker_yml(){
    local site_names=($1)
    local hosts=($2)
    local ports=($3)

    local i
    for i in $(seq 0 $((${#site_names[*]} - 1)))
    do
	local docker_yml_file=$SHIP_DIR/${site_names[$i]}/docker-compose.yml
	local host=${hosts[$i]}
	local web_port=$(($WEB_PORT_START + ${ports[$i]}))
	local mobile_port=$(($MOBILE_PORT_START + ${ports[$i]}))
	local ssh_port=$(($SSH_PORT_START + ${ports[$i]}))

	echo "Writing [$docker_yml_file] ($host, $web_port, $mobile_port)..."
	[ ! -e $(dirname $docker_yml_file) ] && mkdir -v $(dirname $docker_yml_file)

	## Output minimum site configuration
	echo "version: \"2.0\"
services:

 # Mad-Gantry Ship Platform
 ${site_names[$i]}:
  image: $SHIP_IMAGE
  ports:
    - \"${web_port}:$DEFAULT_WEB_PORT\"
    - \"${mobile_port}:$DEFAULT_MOBILE_PORT\"
    - \"${ssh_port}:$DEFAULT_SSH_PORT\"
  volumes: 
    - \"$PWD/$PAYLOADS_DIR/sites/${site_names[$i]}:$PAYLOAD_SITES/${site_names[$i]}\"
    - \"$PWD/$PAYLOADS_DIR/data:$PAYLOAD_DATA\"
    - \"$PWD/$PAYLOADS_DIR/devel:$PAYLOAD_DEVEL\"
" > $docker_yml_file
    done

}


output_meta_meta_config(){
    local site_names=($1)
    local hosts=($2)
    local ports=($3)
    local site_dir=$4
    local meta_meta_json=$site_dir/meta-meta.json

    ## Outputting a meta_meta_config content
    [ ! -e $site_dir ] && mkdir -pv $site_dir
    if [ -z "$1" ] && [ -e $meta_meta_json ]; then
	echo "Skipping [$meta_meta_json]" && return 0
    fi

    ## Begining
    echo "Writing [$meta_meta_json] ..."
    echo "[{" > $meta_meta_json

    local i
    for i in $(seq 0 $((${#site_names[*]} - 1)))
    do

	## Main content
	local web_port=$(($WEB_PORT_START + ${ports[$i]}))
	local mobile_port=$(($MOBILE_PORT_START + ${ports[$i]}))

	echo "   \"name\": \"${site_names[$i]}\",
   \"host\": \"${hosts[$i]}\",
   \"web_port\": \"${web_port}\",
   \"mobile_port\": \"${mobile_port}\",
   \"dir\": \"sites/${site_names[$i]}\" " >> $meta_meta_json

	## Next
	[ $i -ne $((${#site_names[*]} - 1)) ] && echo "},{" >> $meta_meta_json
    done

    ## Ending
    echo "}]" >> $meta_meta_json

    return 0
}


copy_site_configs(){
    local level=$1
    local site_dir=$2
    local site=$(basename $site_dir)

    [ ! -e $site_dir ] && mkdir -pv $site_dir

    ## Copying default site configuration
    if [ -e configs/$level ]; then
	echo "Copying [$site] site configuration from [configs/$level]..."
	cp -r configs/$level/* $site_dir
    fi

    ## Overwriting by custom configurations
    if [ -e configs/customs/$site ]; then
	echo "Copying [$site] custom onfiguration from [configs/customs/$site]..."
	cp -rv configs/customs/$site/* $site_dir
    fi
}


## This function is generating template of a "top" level container into a ship directory
put_top_container_onto_ship(){
    local site_dir=$PAYLOADS_DIR/sites/$LEVEL0_SITE

    output_docker_yml "$LEVEL0_SITE" "$LEVEL0_HOST" "$LEVEL0_PORT"
    copy_site_configs level0 $site_dir
    output_meta_meta_config "${LEVEL1_SITES[*]}" "${LEVEL1_HOSTS[*]}" "${LEVEL1_PORTS[*]}" $site_dir
}


## This function is generating template of "contry" level container(s) into a ship directory
put_country_container_onto_ship(){
    local country=$1
    local i
    for i in $(seq 0 $((${#LEVEL1_SITES[*]} - 1)))
    do
	if [ "${LEVEL1_SITES[$i]}" == "$country" ] || [ "$country" == "all" ]; then
	    local country_code=${LEVEL1_SITES[$i]}
	    output_docker_yml "${LEVEL1_SITES[$i]}" "${LEVEL1_HOSTS[$i]}" "${LEVEL1_PORTS[$i]}"

	    local sites=$(eval echo "\${LEVEL2_${country_code}_SITES[*]}")
	    local hosts=$(eval echo "\${LEVEL2_${country_code}_HOSTS[*]}")
	    local ports=$(eval echo "\${LEVEL2_${country_code}_PORTS[*]}")
	    local site_dir=$PAYLOADS_DIR/sites/$country_code
	    copy_site_configs level1 $site_dir
	    output_meta_meta_config "$sites" "$hosts" "$ports" $site_dir
	fi
    done
}


## This function is generating template of "site" level container(s) into a ship directory
put_site_container_onto_ship(){
    local site=$1

    local i
    for i in $(seq 0 $((${#ALL_LEVEL2_SITES[*]} - 1)))
    do
	if [ "${ALL_LEVEL2_SITES[$i]}" == "$site" ] || [ "$site" == "all" ]; then
	    local site_dir=$PAYLOADS_DIR/sites/${ALL_LEVEL2_SITES[$i]}
	    output_docker_yml "${ALL_LEVEL2_SITES[$i]}" "${ALL_LEVEL2_HOSTS[$i]}" "${ALL_LEVEL2_PORTS[$i]}"
	    copy_site_configs level2 $site_dir
	    output_meta_meta_config "" "" "" $site_dir
	fi
    done
}


prepare_madmask_devel_env(){
    pushd $PAYLOADS_DIR
    [ ! -e data ] && mkdir -v data
    if [ ! -e devel ]; then
	git clone https://github.com/HappyFaceGoettingen/HappyFace-MadMask.git
	ln -s HappyFace-MadMask devel
    fi
    popd
}


#--------------------------
# Getopt
#--------------------------
while getopts "dnt:a:y:ATC:S:s:hv" op
  do
  case $op in
      d) prepare_madmask_devel_env
	  ;;
      n) DOCKER_COMPOSE_NO_CACHE="--no-cache"
	  ;;
      t) TEMPLATE_DIR=templates/$OPTARG
	  [ ! -e $TEMPLATE_DIR ] && echo "No template for [$TEMPLATE_DIR]" && exit -1
	  YML_FILE=$TEMPLATE_DIR/docker-compose.yml
	  ;;
      y) YML_FILE=$OPTARG
	  ;;
      a) docker_compose_action $OPTARG
	  ;;
      A) put_top_container_onto_ship
	  put_country_container_onto_ship all
	  put_site_container_onto_ship all
	  ;;
      T) put_top_container_onto_ship
	  ;;
      C) put_country_container_onto_ship $OPTARG
	  ;;
      S) put_site_container_onto_ship $OPTARG
	  ;;
      s) TEMPLATE_DIR=$SHIP_DIR/$OPTARG
	  [ ! -e $TEMPLATE_DIR ] && echo "No template for [$TEMPLATE_DIR]" && exit -1
	  YML_FILE=$TEMPLATE_DIR/docker-compose.yml
	  ;;
      h) echo "$usage"
	  exit 0
	  ;;
      v) echo "$version"
	  exit 0
	  ;;
      ?) echo "$usage"
	  exit 0
	  ;;
  esac
done



