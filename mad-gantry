#!/bin/bash

## Check requirements
! which docker-compose &> /dev/null && echo "docker-compose does not exist" && exit -1

## making dirs
cd $(dirname $0)
source mad-gantry.conf

[ ! -e $SHIP_DIR ] && mkdir -v $SHIP_DIR
[ ! -e $PAYLOADS_DIR ] && mkdir -v $PAYLOADS_DIR

## Set a YML template
YML_FILE=$HF_CORE_TEMPLATE/docker-compose.yml

usage="$0 [option]

 -n:  Use docker-compose no-cache option
 -y:  Set a template YML file [default: $YML_FILE]
 -a:  Actions [build/up/down/logs]


 -s:  Generate ship

 -c:  Put country containers onto a ship  [all or country_code]
 -p:  Put site containers onto a ship [all or site]


 Report Bugs to Gen Kawamura <gen.kawamura@cern.ch>"

if [ $# -eq 0 ]; then
    echo "$usage"
    exit 0
fi


#--------------------------
# Functions
#--------------------------
docker_compose_action(){
    case $1 in
	build)
	    docker-compose -f $YML_FILE build $DOCKER_COMPOSE_NO_CACHE
	    ;;
	up)
	    docker-compose -f $YML_FILE up -d
	    ;;
	down)
	    docker-compose -f $YML_FILE down
	    ;;
	logs)
	    docker-compose -f $YML_FILE logs
	    ;;
	*)
	    echo "$usage"
	    exit -1
	    ;;
    esac
}


#--------------------------
# Getopt
#--------------------------
while getopts "na:y:c:p:shv" op
  do
  case $op in
      n) DOCKER_COMPOSE_NO_CACHE="--no-cache"
	  ;;
      y) YML_FILE=$OPTARG
	  ;;
      a) docker_compose_action $OPTARG
	  ;;
      c) put_container_onto_country_ship $OPTARG
	  ;;
      p) put_container_onto_ship $OPTARG
	  ;;
      s) generate_ship
	  ;;
      h) echo "$usage"
	  exit 0
	  ;;
      v) echo "$version"
	  exit 0
	  ;;
      ?) echo "$usage"
	  exit 0
	  ;;
  esac
done



