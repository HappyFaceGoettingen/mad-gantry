#!/bin/bash

## Check requirements
! which docker-compose &> /dev/null && echo "docker-compose does not exist" && exit -1

## making dirs
cd $(dirname $0)
source mad-gantry.conf

[ ! -e $SHIP_DIR ] && mkdir -v $SHIP_DIR
[ ! -e $PAYLOADS_DIR ] && mkdir -v $PAYLOADS_DIR

## Set a default YML template
TEMPLATE_DIR=templates/hf.core
YML_FILE=$TEMPLATE_DIR/docker-compose.yml

usage="$0 [option]

$(basename $0), which uses docker-compose, is designed to build the standard HappyFace/HappyFaceMobile/Kibana Monitoring systems on containers. This powerful command can easily ship many complex monitoring frameworks to Cloud/Cluster/WLCG environments.


 -n:  Use docker-compose no-cache option
 -y:  Set a template YML file [default: $YML_FILE]
 -t:  Select a template [hf.core/hf.mobile/xdesktop/jenkins/docker-elk/TD]
 -a:  Actions [build/up/down/logs]


 -s:  Generate ship

 -c:  Put country containers onto a ship  [all or country_code]
 -p:  Put site containers onto a ship [all or site]


 * Examples

 ** Build hf.core images and run them
 $0 -a build; $0 -a up

 ** Build xdesktop images and run them
 $0 -t xdesktop -a build; $0 -t xdesktop -a up


 Report Bugs to Gen Kawamura <gen.kawamura@cern.ch>"

if [ $# -eq 0 ]; then
    echo "$usage"
    exit 0
fi


#--------------------------
# Functions
#--------------------------
docker_compose_action(){
    case $1 in
	build)
	    docker-compose -f $YML_FILE build $DOCKER_COMPOSE_NO_CACHE
	    ;;
	up)
	    docker-compose -f $YML_FILE up -d
	    ;;
	down)
	    docker-compose -f $YML_FILE down
	    ;;
	logs)
	    docker-compose -f $YML_FILE logs
	    ;;
	*)
	    echo "$usage"
	    exit -1
	    ;;
    esac
}


#--------------------------
# Getopt
#--------------------------
while getopts "nt:a:y:c:p:shv" op
  do
  case $op in
      n) DOCKER_COMPOSE_NO_CACHE="--no-cache"
	  ;;
      t) TEMPLATE_DIR=templates/$OPTARG
	  [ ! -e $TEMPLATE_DIR ] && echo "No template for [$TEMPLATE_DIR]" && exit -1
	  YML_FILE=$TEMPLATE_DIR/docker-compose.yml
	  ;;
      y) YML_FILE=$OPTARG
	  ;;
      a) docker_compose_action $OPTARG
	  ;;
      c) put_container_onto_country_ship $OPTARG
	  ;;
      p) put_container_onto_ship $OPTARG
	  ;;
      s) generate_ship
	  ;;
      h) echo "$usage"
	  exit 0
	  ;;
      v) echo "$version"
	  exit 0
	  ;;
      ?) echo "$usage"
	  exit 0
	  ;;
  esac
done



